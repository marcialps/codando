<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevGame - Algoritmos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #181a1b;
            color: #f1f1f1;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 400px;
            margin: 40px auto;
            background: #23272b;
            padding: 32px 24px;
            border-radius: 10px;
            box-shadow: 0 2px 16px #000a;
        }
        h2 {
            text-align: center;
            color: #fff;
        }
        .hidden { display: none; }
        input, textarea {
            width: 100%;
            margin: 12px 0;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #444;
            background: #181a1b;
            color: #f1f1f1;
            font-size: 1rem;
            transition: border 0.2s;
        }
        input:focus, textarea:focus {
            border: 1.5px solid #007bff;
            outline: none;
        }
        button {
            width: 100%;
            margin: 12px 0;
            padding: 10px;
            border-radius: 5px;
            border: none;
            background: linear-gradient(90deg, #007bff 60%, #0056b3 100%);
            color: #fff;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            box-shadow: 0 2px 8px #0004;
            transition: background 0.2s;
        }
        button:disabled {
            background: #333;
            color: #888;
            cursor: not-allowed;
        }
        .timer {
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 10px;
            color: #00c3ff;
        }
        .success {
            color: #00e676;
            text-align: center;
        }
        label {
            color: #b0b0b0;
        }
        #enunciado-recebido {
            background: #22262a;
            color: #f1f1f1;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            border: 1px solid #333;
        }
    </style>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="container">
        <!-- Tela 1: Nome -->
        <div id="tela-nome">
            <h2>Bem-vindo!</h2>
            <label for="nome">Digite seu nome:</label>
            <input type="text" id="nome" maxlength="30" autocomplete="off">
            <button onclick="entrar()">Entrar</button>
        </div>

        <!-- Tela 2: Enunciado -->
        <div id="tela-enunciado" class="hidden">
            <h2>Crie um Enunciado</h2>
            <div class="timer" id="timer-enunciado"></div>
            <label for="enunciado">Descreva um problema para ser resolvido com um algoritmo:</label>
            <textarea id="enunciado" rows="4" maxlength="300"></textarea>
            <button onclick="enviarEnunciado()">Enviar Enunciado</button>
        </div>

        <!-- Tela 3: Sorteio -->
        <div id="tela-sorteio" class="hidden">
            <h2>Sorteando enunciados...</h2>
            <div class="timer" id="timer-sorteio"></div>
            <p>Aguarde enquanto os enunciados s√£o sorteados entre os participantes.</p>
        </div>

        <!-- Tela 4: Receber Enunciado -->
        <div id="tela-receber" class="hidden">
            <h2>Resolva o Enunciado</h2>
            <div class="timer" id="timer-resolver"></div>
            <p><strong>Enunciado sorteado:</strong></p>
            <div id="enunciado-recebido"></div>
            <label for="algoritmo">Cole ou escreva seu algoritmo:</label>
            <textarea id="algoritmo" rows="6" maxlength="1000"></textarea>
            <button onclick="enviarAlgoritmo()">Enviar Algoritmo</button>
        </div>

        <!-- Tela 5: Confirma√ß√£o -->
        <div id="tela-final" class="hidden">
            <h2>Obrigado!</h2>
            <p class="success">Seu algoritmo foi enviado para o autor do enunciado.</p>
        </div>

        <!-- Tela 6: Administra√ß√£o (apenas para 'cko') -->
        <div id="tela-admin" class="hidden">
            <h2>Administra√ß√£o</h2>
            <button onclick="resetarTudo()">Resetar Tudo (alunos, enunciados, respostas)</button>
            <button onclick="apagarEnunciados()">Apagar Apenas Enunciados</button>
            <h3 style="margin-top:24px; color:#00c3ff;">Configura√ß√£o de Tempos</h3>
            <form id="form-tempos" onsubmit="salvarTempos(event)">
                <label for="tempoEnunciadoInput">Tempo para criar enunciado:</label>
                <div style="display:flex;align-items:center;gap:8px;">
                    <input type="number" id="tempoEnunciadoInput" min="5" max="600" value="30" style="width:80px;">
                    <span id="tempoEnunciadoMin">(0,5 min)</span>
                </div>
                <label for="tempoSorteioInput">Tempo de sorteio:</label>
                <div style="display:flex;align-items:center;gap:8px;">
                    <input type="number" id="tempoSorteioInput" min="2" max="60" value="5" style="width:80px;">
                    <span id="tempoSorteioMin">(0,08 min)</span>
                </div>
                <label for="tempoResolverInput">Tempo para resolver:</label>
                <div style="display:flex;align-items:center;gap:8px;">
                    <input type="number" id="tempoResolverInput" min="10" max="1800" value="60" style="width:80px;">
                    <span id="tempoResolverMin">(1 min)</span>
                </div>
                <button type="submit">Salvar Tempos</button>
            </form>
            <button onclick="voltarParaLogin()" style="margin-top:20px;background:#444;">Sair da Administra√ß√£o</button>
        </div>

        <!-- Tela 7: Respostas Recebidas (para o autor do enunciado) -->
        <div id="tela-respostas" class="hidden">
            <h2>Respostas Recebidas</h2>
            <div id="respostas-lista"></div>
            <button onclick="voltarParaLogin()" style="margin-top:20px;background:#444;">Sair</button>
        </div>

        <!-- Tela 8: Visualizar Algoritmo Enviado -->
        <div id="tela-algoritmo-enviado" class="hidden">
            <h2>Algoritmo Enviado</h2>
            <div id="algoritmo-enviado-info"></div>
            <label>Coment√°rio para o autor do enunciado:</label><br>
            <input type="text" id="comentario-enviado" style="width:80%;background:#181a1b;color:#fff;border:1px solid #444;border-radius:5px;">
            <button onclick="salvarComentarioEnviado()">Salvar Coment√°rio</button><br><br>
            <label>Enviar emotion para o autor:</label>
            <span style='font-size:1.5em;cursor:pointer;' onclick='enviarEmotionEnviado("üëç")'>üëç</span>
            <span style='font-size:1.5em;cursor:pointer;' onclick='enviarEmotionEnviado("üëè")'>üëè</span>
            <span style='font-size:1.5em;cursor:pointer;' onclick='enviarEmotionEnviado("ü§î")'>ü§î</span>
            <span style='font-size:1.5em;cursor:pointer;' onclick='enviarEmotionEnviado("üí°")'>üí°</span>
            <span style='font-size:1.5em;cursor:pointer;' onclick='enviarEmotionEnviado("üî•")'>üî•</span>
            <span id='emotion-enviado' style='margin-left:10px;'></span>
            <br><br>
            <button onclick="voltarParaLogin()" style="background:#444;">Sair</button>
        </div>

        <!-- Tela 9: Feedback Recebido pelo Autor do Algoritmo -->
        <div id="tela-feedback-recebido" class="hidden">
            <h2>Feedback do Autor do Enunciado</h2>
            <div id="feedback-recebido-info"></div>
            <button onclick="voltarParaLogin()" style="background:#444;">Sair</button>
        </div>
    </div>

    <script>
    // Configura√ß√£o do Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyA-uWiH8rgvzF1hC22_bLeP_DGtes5j8MQ",
        authDomain: "sortedev-dccca.firebaseapp.com",
        projectId: "sortedev-dccca",
        storageBucket: "sortedev-dccca.firebasestorage.app",
        messagingSenderId: "436355454724",
        appId: "1:436355454724:web:17b34396431a6908c2a251",
        measurementId: "G-BC1PD2RS4B"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let meuNome = "";
    let meuEnunciado = "";
    let enunciadoSorteado = null;
    let tempoEnunciado = 30; // segundos para criar enunciado
    let tempoSorteio = 5; // segundos para "sortear"
    let tempoResolver = 60; // segundos para resolver
    let timerInterval = null;

    // Atualiza exibi√ß√£o dos minutos ao alterar os inputs
    function atualizarMinutos() {
        document.getElementById('tempoEnunciadoMin').textContent = `(${(document.getElementById('tempoEnunciadoInput').value/60).toFixed(2)} min)`;
        document.getElementById('tempoSorteioMin').textContent = `(${(document.getElementById('tempoSorteioInput').value/60).toFixed(2)} min)`;
        document.getElementById('tempoResolverMin').textContent = `(${(document.getElementById('tempoResolverInput').value/60).toFixed(2)} min)`;
    }
    document.addEventListener('DOMContentLoaded', () => {
        ['tempoEnunciadoInput','tempoSorteioInput','tempoResolverInput'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', atualizarMinutos);
        });
        atualizarMinutos();
    });

    async function entrar() {
        const nome = document.getElementById('nome').value.trim();
        if (!nome) { alert('Digite seu nome!'); return; }
        meuNome = nome;
        if (nome === 'cko') {
            mostrarTela('tela-admin');
            carregarTempos();
            atualizarMinutos();
            return;
        }
        // Adiciona aluno √† cole√ß√£o 'alunos' se n√£o existir
        const alunoRef = db.collection('alunos').doc(nome);
        const doc = await alunoRef.get();
        if (!doc.exists) {
            await alunoRef.set({ nome });
        }
        mostrarTela('tela-enunciado');
        iniciarTimer('timer-enunciado', tempoEnunciado, finalizarEnunciado);
        monitorarEnunciados();
        // Se for autor de algum enunciado, ativa a tela de respostas ao vivo
        const meusEnuns = await db.collection('enunciados').where('nome', '==', meuNome).get();
        if (!meusEnuns.empty) {
            ativarRespostasAoVivo();
        }
    }

    function mostrarTela(id) {
        document.querySelectorAll('.container > div').forEach(div => div.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function iniciarTimer(elementId, segundos, aoFinalizar) {
        let tempo = segundos;
        document.getElementById(elementId).textContent = `Tempo restante: ${tempo}s`;
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            tempo--;
            document.getElementById(elementId).textContent = `Tempo restante: ${tempo}s`;
            if (tempo <= 0) {
                clearInterval(timerInterval);
                aoFinalizar();
            }
        }, 1000);
    }

    // --- NOVA L√ìGICA DE SORTEIO ---
    let enviouEnunciado = false;
    let monitorando = false;
    let monitorInterval = null;
    let alunosDaRodada = [];

    async function monitorarEnunciados() {
        if (monitorando) return;
        monitorando = true;
        // Pega lista de alunos da rodada
        const snap = await db.collection('alunos').get();
        alunosDaRodada = [];
        snap.forEach(doc => alunosDaRodada.push(doc.id));
        monitorInterval = setInterval(async () => {
            const enuns = await db.collection('enunciados').get();
            const nomesComEnunciado = new Set();
            enuns.forEach(doc => nomesComEnunciado.add(doc.data().nome));
            // Se todos j√° enviaram, ou o tempo acabou, libera sorteio
            if (alunosDaRodada.every(nome => nomesComEnunciado.has(nome))) {
                clearInterval(monitorInterval);
                if (!enviouEnunciado) finalizarEnunciado();
                // Finaliza a rodada de algoritmos ap√≥s um pequeno delay para garantir que todos salvaram
                setTimeout(finalizarRodadaAlgoritmos, 2000);
            }
        }, 1500);
    }

    async function enviarEnunciado() {
        const enunciado = document.getElementById('enunciado').value.trim();
        if (!enunciado) { alert('Digite um enunciado!'); return; }
        meuEnunciado = enunciado;
        enviouEnunciado = true;
        // Salva enunciado na cole√ß√£o 'enunciados'
        await db.collection('enunciados').add({ nome: meuNome, enunciado });
        mostrarTela('tela-sorteio');
        // O sorteio s√≥ ser√° liberado pelo monitoramento
    }

    function finalizarEnunciado() {
        if (!meuEnunciado) enviarEnunciado();
        else {
            mostrarTela('tela-sorteio');
            // O sorteio s√≥ ser√° liberado pelo monitoramento
            setTimeout(() => {
                sortearEnunciado();
            }, 1000);
        }
    }

    // --- SORTEIO SEM REPETI√á√ÉO ---
    let sorteioRealizado = false;
    let sorteioMap = {};

    async function sortearEnunciado() {
        if (sorteioRealizado) return;
        sorteioRealizado = true;
        // Busca todos os enunciados
        const snap = await db.collection('enunciados').get();
        const enunciados = [];
        snap.forEach(doc => {
            const data = doc.data();
            enunciados.push({ id: doc.id, ...data });
        });
        // Participantes da rodada
        const participantes = enunciados.map(e => e.nome);
        // Gera sorteio sem repeti√ß√µes e sem autoatribui√ß√£o
        sorteioMap = gerarSorteioSemRepeticao(participantes);
        // Descobre qual enunciado o participante deve receber
        const nomeSorteado = sorteioMap[meuNome];
        const enunciadoSorteadoObj = enunciados.find(e => e.nome === nomeSorteado);
        enunciadoSorteado = enunciadoSorteadoObj;
        mostrarTela('tela-receber');
        document.getElementById('enunciado-recebido').textContent = enunciadoSorteado.enunciado;
        iniciarTimer('timer-resolver', tempoResolver, enviarAlgoritmo);
    }

    // Fun√ß√£o para sortear sem repeti√ß√µes e sem autoatribui√ß√£o
    function gerarSorteioSemRepeticao(nomes) {
        let tentativas = 0;
        while (tentativas < 1000) {
            // Embaralha os nomes
            const embaralhado = nomes.slice().sort(() => Math.random() - 0.5);
            let valido = true;
            for (let i = 0; i < nomes.length; i++) {
                if (nomes[i] === embaralhado[i]) {
                    valido = false;
                    break;
                }
            }
            if (valido) {
                // Monta o mapa: participante -> nome sorteado
                const mapa = {};
                for (let i = 0; i < nomes.length; i++) {
                    mapa[nomes[i]] = embaralhado[i];
                }
                return mapa;
            }
            tentativas++;
        }
        alert('N√£o foi poss√≠vel sortear sem repeti√ß√µes. Tente novamente.');
        location.reload();
        return {};
    }

    let respostaEnviadaId = null;

    async function enviarAlgoritmo() {
        const algoritmo = document.getElementById('algoritmo').value.trim();
        if (!algoritmo) { alert('Cole ou escreva seu algoritmo!'); return; }
        // Salva algoritmo na cole√ß√£o 'respostas'
        const docRef = await db.collection('respostas').add({
            para: enunciadoSorteado.nome,
            de: meuNome,
            algoritmo,
            enunciado: enunciadoSorteado.enunciado,
            comentario: '',
            emotion: '',
            feedbackEnviado: false,
            feedbackComentario: '',
            feedbackEmotion: '',
            rodadaFinalizada: false
        });
        respostaEnviadaId = docRef.id;
        clearInterval(timerInterval);
        mostrarTela('tela-final');
        ativarFeedbackAoVivo();
        // N√£o ativa o listener para o autor do enunciado imediatamente
    }

    function exibirAlgoritmoEnviado(algoritmo, enunciado, autor) {
        document.getElementById('algoritmo-enviado-info').innerHTML = `
            <b>Enunciado recebido de <span style='color:#00c3ff'>${autor}</span>:</b><br>
            <span style='color:#00c3ff'>${enunciado}</span><br><br>
            <b>Seu algoritmo enviado:</b><br>
            <textarea style='width:100%;background:#181a1b;color:#fff;border:1px solid #444;border-radius:5px;' rows='6' readonly>${algoritmo}</textarea><br><br>
        `;
    }

    async function salvarComentarioEnviado() {
        const val = document.getElementById('comentario-enviado').value;
        if (!respostaEnviadaId) return;
        await db.collection('respostas').doc(respostaEnviadaId).update({ comentario: val });
    }
    async function enviarEmotionEnviado(emoji) {
        if (!respostaEnviadaId) return;
        await db.collection('respostas').doc(respostaEnviadaId).update({ emotion: emoji });
        document.getElementById('emotion-enviado').textContent = emoji;
    }

    // Fun√ß√µes de administra√ß√£o
    async function resetarTudo() {
        if (!confirm('Tem certeza que deseja apagar tudo?')) return;
        // Apaga todas as cole√ß√µes
        await apagarColecao('alunos');
        await apagarColecao('enunciados');
        await apagarColecao('respostas');
        alert('Tudo apagado!');
    }
    async function apagarEnunciados() {
        if (!confirm('Tem certeza que deseja apagar todos os enunciados?')) return;
        await apagarColecao('enunciados');
        alert('Enunciados apagados!');
    }
    async function apagarColecao(nomeColecao) {
        const snap = await db.collection(nomeColecao).get();
        const batch = db.batch();
        snap.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
    }
    function voltarParaLogin() {
        mostrarTela('tela-nome');
    }
    // Configura√ß√£o de tempos
    function carregarTempos() {
        const tempos = JSON.parse(localStorage.getItem('devgame_tempos') || '{}');
        document.getElementById('tempoEnunciadoInput').value = tempos.tempoEnunciado || 30;
        document.getElementById('tempoSorteioInput').value = tempos.tempoSorteio || 5;
        document.getElementById('tempoResolverInput').value = tempos.tempoResolver || 60;
    }
    function salvarTempos(event) {
        event.preventDefault();
        const tempoEnunciado = parseInt(document.getElementById('tempoEnunciadoInput').value);
        const tempoSorteio = parseInt(document.getElementById('tempoSorteioInput').value);
        const tempoResolver = parseInt(document.getElementById('tempoResolverInput').value);
        localStorage.setItem('devgame_tempos', JSON.stringify({ tempoEnunciado, tempoSorteio, tempoResolver }));
        alert('Tempos salvos! Eles ser√£o usados nos pr√≥ximos acessos.');
    }
    // Ao carregar a p√°gina, ler tempos do localStorage
    (function(){
        const tempos = JSON.parse(localStorage.getItem('devgame_tempos') || '{}');
        if (tempos.tempoEnunciado) tempoEnunciado = tempos.tempoEnunciado;
        if (tempos.tempoSorteio) tempoSorteio = tempos.tempoSorteio;
        if (tempos.tempoResolver) tempoResolver = tempos.tempoResolver;
    })();

    // Exibe para o criador do enunciado o algoritmo recebido e permite feedback
    function ativarRespostasAoVivo() {
        if (unsubscribeRespostas) unsubscribeRespostas();
        if (!meuNome) return;
        unsubscribeRespostas = db.collection('respostas')
            .where('para', '==', meuNome)
            .where('rodadaFinalizada', '==', true)
            .onSnapshot(snap => {
                if (snap.empty) return;
                mostrarTela('tela-respostas');
                const lista = document.getElementById('respostas-lista');
                lista.innerHTML = '';
                snap.forEach(doc => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    div.style = 'background:#23272b;border:1px solid #333;border-radius:8px;padding:12px;margin-bottom:18px;';
                    div.innerHTML = `
                        <b>Enunciado:</b><br><span style='color:#00c3ff'>${data.enunciado}</span><br><br>
                        <b>Algoritmo enviado por <span style='color:#00e676'>${data.de}</span>:</b><br>
                        <textarea style='width:100%;background:#181a1b;color:#fff;border:1px solid #444;border-radius:5px;' rows='6' readonly>${data.algoritmo}</textarea><br><br>
                        <label>Coment√°rio para o autor do algoritmo:</label><br>
                        <input type='text' style='width:80%;background:#181a1b;color:#fff;border:1px solid #444;border-radius:5px;' value='${data.feedbackComentario || ''}' id='feedback-comentario-${doc.id}'>
                        <br><br>
                        <label>Enviar emotion:</label>
                        <span style='font-size:1.5em;cursor:pointer;' onclick='selecionarFeedbackEmotion("${doc.id}","üëç")'>üëç</span>
                        <span style='font-size:1.5em;cursor:pointer;' onclick='selecionarFeedbackEmotion("${doc.id}","üëè")'>üëè</span>
                        <span style='font-size:1.5em;cursor:pointer;' onclick='selecionarFeedbackEmotion("${doc.id}","ü§î")'>ü§î</span>
                        <span style='font-size:1.5em;cursor:pointer;' onclick='selecionarFeedbackEmotion("${doc.id}","üí°")'>üí°</span>
                        <span style='font-size:1.5em;cursor:pointer;' onclick='selecionarFeedbackEmotion("${doc.id}","üî•")'>üî•</span>
                        <span id='feedback-emotion-${doc.id}' style='margin-left:10px;'>${data.feedbackEmotion || ''}</span>
                        <br><br>
                        <button onclick='enviarFeedbackParaAutor("${doc.id}")'>Enviar Feedback</button>
                    `;
                    lista.appendChild(div);
                });
            });
    }

    // Fun√ß√£o para selecionar emotion de feedback
    function selecionarFeedbackEmotion(id, emoji) {
        document.getElementById('feedback-emotion-' + id).textContent = emoji;
    }

    // Fun√ß√£o para enviar feedback para o autor do algoritmo
    async function enviarFeedbackParaAutor(id) {
        const comentario = document.getElementById('feedback-comentario-' + id).value;
        const emotion = document.getElementById('feedback-emotion-' + id).textContent;
        await db.collection('respostas').doc(id).update({
            feedbackComentario: comentario,
            feedbackEmotion: emotion,
            feedbackEnviado: true
        });
        alert('Feedback enviado!');
    }

    // Listener para mostrar feedback recebido ao autor do algoritmo
    function ativarFeedbackAoVivo() {
        if (!meuNome) return;
        db.collection('respostas')
            .where('de', '==', meuNome)
            .orderBy('feedbackEnviado', 'desc')
            .limit(1)
            .onSnapshot(snap => {
                snap.forEach(doc => {
                    const data = doc.data();
                    if (data.feedbackEnviado) {
                        mostrarTela('tela-feedback-recebido');
                        document.getElementById('feedback-recebido-info').innerHTML = `
                            <b>Enunciado:</b><br><span style='color:#00c3ff'>${data.enunciado}</span><br><br>
                            <b>Seu algoritmo enviado:</b><br>
                            <textarea style='width:100%;background:#181a1b;color:#fff;border:1px solid #444;border-radius:5px;' rows='6' readonly>${data.algoritmo}</textarea><br><br>
                            <b>Coment√°rio do autor:</b><br>
                            <span style='color:#00e676'>${data.feedbackComentario || ''}</span><br><br>
                            <b>Emotion:</b> <span style='font-size:1.5em;'>${data.feedbackEmotion || ''}</span>
                        `;
                    }
                });
            });
    }

    // Ao final da rodada, marcar todas as respostas como rodadaFinalizada: true
    // Chame isso ao final do tempo ou quando todos enviarem
    async function finalizarRodadaAlgoritmos() {
        // Busca todas as respostas da rodada (pode filtrar por enunciados da rodada se quiser)
        const snap = await db.collection('respostas').where('rodadaFinalizada', '==', false).get();
        const batch = db.batch();
        snap.forEach(doc => batch.update(doc.ref, { rodadaFinalizada: true }));
        await batch.commit();
    }
    </script>
</body>
</html>
